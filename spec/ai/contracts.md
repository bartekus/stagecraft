# AI Contracts & Determinism

## 1. AI Context Schema (`.ai-context/`)

The `.ai-context/` directory contains the processed, AI-ready representation of the repository. It is generated by Cortex.

### Structure
```text
.ai-context/
  meta.json
  digest.txt
  files/
    manifest.json
    chunks.ndjson
```

### `meta.json`
Metadata about the context build.
**Strict Rule**: NO timestamps.

```json
{
  "project_name": "stagecraft",
  "repo_slug": "bartekus/stagecraft",
  "revision": "git-commit-sha",
  "generator": "cortex-v1.0.0"
}
```

### `digest.txt`
A single line containing the SHA-256 hash of the entire context state. Used for caching and change detection.

### `files/manifest.json`
A flat list of all files included in the context, sorted by path.

```json
[
  {
    "path": "README.md",
    "hash": "sha256:...",
    "tags": ["documentation"]
  },
  ...
]
```

### `files/chunks.ndjson`
The actual content, chunked for LLM consumption.
**Format**: Newline Delimited JSON.
**Ordering**: Sorted strictly by `file_path` then `start_line`.

```json
{"file_path": "README.md", "start_line": 1, "end_line": 50, "content": "..."}
{"file_path": "main.go", "start_line": 1, "end_line": 60, "content": "..."}
```

---

## 2. The Determinism Contract

Determinism is the primary correctness criteria for Cortex and XRAY.

### The Definition
> "Given the same repository state (file contents), the system MUST produce byte-for-byte identical outputs in `.ai-context/` and `.xraycache/`."

### Constraints
1.  **No Environment Leakage**: Outputs must not depend on absolute paths (`/Users/bart/...`) or environment variables (`USER`, `HOME`).
2.  **No Time Leakage**: Timestamps (`2025-12-16...`) are forbidden in output artifacts.
3.  **Canonical Sorting**: All lists (JSON arrays, NDJSON lines) must be sorted by a stable key (usually `path`).
4.  **Stable Serialization**: JSON must be marshaled consistently (e.g., specific creation order or canonical sorting of keys).

### Forbidden Fields

The following fields MUST NOT appear in any persisted output:

- `indexedAt`
- `scannedAt`
- `generatedAt`
- `createdAt`
- `updatedAt`
- `durationMs`
- `elapsedMs`

Any appearance of these fields is a determinism violation.

### CI & Golden Tests
All Cortex and XRAY changes must be verified by **Golden Tests**.

**Golden Test Protocol**:
1.  Run the tool against a fixed `testdata/` repository.
2.  Compare the output strictly against a committed `testdata/golden/` directory.
3.  **Failure Condition**: Any byte difference is a test failure.

### Developer Workflow
- If you change logic that affects output, you must explicitly regenerate the golden files and commit them.
- CI verifies that `cortex context build` produces no git diffs in generated directories (if checked in) or matches the golden expectation.
