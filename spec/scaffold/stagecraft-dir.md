# .stagecraft/ Directory Structure

- Feature ID: `SCAFFOLD_STAGECRAFT_DIR`
- Status: todo

## Goal

Define the structure and contents of the `.stagecraft/` directory, which serves as the CLI workspace for generated files, state, and project-specific metadata.

## Directory Structure

The `.stagecraft/` directory is created in the project root and contains:

```
.stagecraft/
├── releases.json          # Release history (deployments, versions, phases)
├── state.json             # Current deployment state (optional, v1)
├── compose/               # Generated docker-compose files
│   ├── docker-compose.override.dev.yml
│   ├── docker-compose.override.staging.yml
│   └── docker-compose.override.prod.yml
├── traefik/               # Traefik dynamic configs (dev only)
│   └── dynamic/
│       └── *.yml
├── agent/                 # AI development guide
│   └── Agent.md           # Project-specific AI instructions
├── tests/                 # Health checks and smoke tests
│   ├── health.sh
│   └── smoke.sh
└── templates/             # Project-specific codegen templates (optional)
    └── *.tmpl
```

## File Descriptions

### `releases.json`

Release history tracking (see `blog/03-migration-strategies.md`):

```json
{
  "releases": [
    {
      "id": "rel-20250101-120000",
      "environment": "prod",
      "version": "v1.2.3",
      "commit_sha": "abc123",
      "timestamp": "2025-01-01T12:00:00Z",
      "phases": {
        "build": "completed",
        "push": "completed",
        "migrate_pre": "completed",
        "rollout": "completed",
        "migrate_post": "completed",
        "finalize": "completed"
      },
      "previous_id": "rel-20241231-120000"
    }
  ]
}
```

### `state.json` (v1, optional)

Current deployment state snapshot:

```json
{
  "environments": {
    "prod": {
      "current_version": "v1.2.3",
      "current_release_id": "rel-20250101-120000",
      "hosts": {
        "plat-gw-1": {
          "status": "healthy",
          "last_updated": "2025-01-01T12:00:00Z"
        }
      }
    }
  }
}
```

### `compose/` Directory

Generated docker-compose override files per environment. These are generated by Stagecraft and should not be edited manually.

### `traefik/dynamic/` Directory

Traefik dynamic configuration files for local development (mkcert mode). Generated during `stagecraft dev`.

### `agent/Agent.md`

Project-specific AI development guide. Can be generated from templates or customized per project. Provides context-specific instructions for AI assistants working on this project.

### `tests/` Directory

Health check and smoke test scripts. These are project-specific and can be customized.

### `templates/` Directory (optional)

Project-specific code generation templates. Used for scaffolding and code generation features (v2).

## Behavior

### Creation

- `.stagecraft/` is created by `stagecraft init` or `stagecraft attach`
- Directory is gitignored by default (add to `.gitignore`)
- Can be manually created if needed

### Lifecycle

- Files are generated and updated by Stagecraft commands
- Users should not manually edit generated files (compose overrides, traefik configs)
- Users can customize: `agent/Agent.md`, `tests/*.sh`, `templates/*.tmpl`

### Git Handling

- `.stagecraft/` should be in `.gitignore` (contains generated files and state)
- Exception: `agent/Agent.md` can be committed if project-specific
- Exception: `tests/` can be committed if shared across team

## Non-Goals (initial version)

- Version control for `.stagecraft/` contents
- Automatic cleanup of old releases
- Remote state backend (v1 uses local files only)

## Tests

See `spec/features.yaml` entry for `SCAFFOLD_STAGECRAFT_DIR`:
- `internal/scaffold/dir_test.go` – unit tests for:
  - Directory creation
  - File generation
  - Gitignore handling
  - State file management

