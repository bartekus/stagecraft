---
feature: GOV_V1_CORE
version: v1
status: todo
domain: commands
inputs:
  flags:
    - name: --format
      type: string
      default: "text"
      description: "Output format: text (default) or json"
    - name: --severity
      type: string
      default: "info"
      description: "Minimum severity to include: info, warning, or error (default: info)"
    - name: --max-suggestions
      type: int
      default: 10
      description: "Maximum number of suggestions to display (default: 10, 0 = unlimited)"
outputs:
  exit_codes:
    success: 0
    error: 1
---
# CLI_COMMIT_SUGGEST - Commit suggestion command

- **Feature ID**: `GOV_V1_CORE`
- **Domain**: `commands`
- **Status**: `todo`
- **Related features**:
  - Phase 3.A: Report types and schemas (done)
  - Phase 3.B: Report generators (done)
  - Phase 3.C: CLI report commands (done)
  - `CLI_COMMIT_REPORT` (done, via Phase 3.C)
  - `CLI_FEATURE_TRACEABILITY` (done, via Phase 3.C)

---

## 1. Purpose

`stagecraft commit suggest` reads the commit health and feature traceability reports generated by Phase 3.C commands and produces actionable, human-readable suggestions for improving commit discipline and feature completeness.

The command:

- Reads `.stagecraft/reports/commit-health.json` (from `stagecraft commit report`)
- Reads `.stagecraft/reports/feature-traceability.json` (from `stagecraft feature traceability`)
- Analyzes violations and problems to generate prioritized suggestions
- Outputs deterministic, human-readable summaries (or JSON for machine consumption)
- Provides specific, actionable guidance for fixing issues

**Non-goals for v1:**

- No automatic commit rewriting (suggestions only)
- No git operations (read-only analysis)
- No interactive prompts (deterministic output only)
- No integration with git hooks (separate concern)

---

## 2. Scope

In v1, `CLI_COMMIT_SUGGEST` supports:

- Reading both report files (commit-health.json, feature-traceability.json)
- Generating suggestions from violations and problems
- Filtering by severity (info, warning, error)
- Limiting output count (--max-suggestions)
- Text and JSON output formats
- Deterministic, stable output suitable for golden file testing

**Future Extensions (not yet implemented in v1):**

- Per-commit rewrite commands (e.g., `--fix-commit <sha>`)
- Interactive mode for guided fixes
- Integration with git hooks for pre-commit suggestions
- Feature-specific suggestions (e.g., "add tests for CLI_DEPLOY")

---

## 3. Command Syntax

### 3.1 Basic Usage

```bash
stagecraft commit suggest
```

Reads both reports from `.stagecraft/reports/` and outputs all suggestions (default: text format, minimum severity: info, max: 10).

### 3.2 Flags

- `--format <text|json>`
  - Optional.
  - Default: `text`
  - Controls output format:
    - `text`: Human-readable, deterministic text output
    - `json`: Machine-readable JSON with structured suggestions

- `--severity <info|warning|error>`
  - Optional.
  - Default: `info`
  - Filters suggestions by minimum severity:
    - `info`: Include all suggestions (info, warning, error)
    - `warning`: Include only warning and error suggestions
    - `error`: Include only error suggestions

- `--max-suggestions <n>`
  - Optional.
  - Default: `10`
  - Limits the number of suggestions displayed:
    - `0`: Unlimited (show all)
    - `n > 0`: Show top N suggestions (prioritized by severity, then by frequency)

- `--config <path>`
  - Optional.
  - Override config file (consistent with `CLI_GLOBAL_FLAGS`).

- `--verbose`
  - Optional.
  - Increase logging verbosity (consistent with `CORE_LOGGING` semantics).

---

## 4. Inputs and Outputs

### 4.1 Inputs

- `.stagecraft/reports/commit-health.json`
  - Generated by `stagecraft commit report`
  - Must exist and be valid JSON
  - Schema version 1.0 (from Phase 3.A)

- `.stagecraft/reports/feature-traceability.json`
  - Generated by `stagecraft feature traceability`
  - Must exist and be valid JSON
  - Schema version 1.0 (from Phase 3.A)

- Repository root (current working directory)
  - Used to resolve report paths
  - No other filesystem access required

### 4.2 Outputs

- **CLI output**:
  - Human-readable summary of suggestions (text format)
  - Or structured JSON with suggestion objects (json format)
  - Output must be deterministic given the same inputs (no random ordering, no timestamps)

- **Exit codes**:
  - `0`: Success (reports read, suggestions generated)
  - `1`: Error (missing reports, invalid JSON, I/O error)

- **No side effects**:
  - Does not modify reports
  - Does not modify git history
  - Does not write files (except stdout/stderr)

---

## 5. Suggestion Generation

### 5.1 Suggestion Types

Suggestions are derived from report data:

#### From Commit Health Report

1. **Format Violations**
   - Source: `commits.<sha>.violations` where `code` indicates format issues
   - Examples:
     - `MISSING_FEATURE_ID`: "Add Feature ID to commit message"
     - `INVALID_TYPE`: "Use valid commit type (feat, fix, refactor, docs, test, ci, chore)"
     - `SUMMARY_TOO_LONG`: "Shorten commit summary to ≤72 characters"
     - `SUMMARY_HAS_TRAILING_PERIOD`: "Remove trailing period from commit summary"

2. **Feature ID Issues**
   - Source: `commits.<sha>.violations` where `code` relates to Feature IDs
   - Examples:
     - `FEATURE_ID_NOT_IN_SPEC`: "Feature ID not found in spec/features.yaml"
     - `INVALID_FEATURE_ID_FORMAT`: "Feature ID must be SCREAMING_SNAKE_CASE"
     - `MULTIPLE_FEATURE_IDS`: "Commit must reference exactly one Feature ID"

3. **Commit Range Issues**
   - Source: `summary` statistics
   - Examples:
     - High invalid commit rate: "Consider running commit message validation in CI"
     - Missing Feature IDs: "Add Feature IDs to commits for traceability"

#### From Feature Traceability Report

1. **Missing Components**
   - Source: `features.<id>.problems` where `code` indicates missing items
   - Examples:
     - `MISSING_SPEC`: "Create spec file for feature <id>"
     - `MISSING_IMPLEMENTATION`: "Add implementation files for feature <id>"
     - `MISSING_TESTS`: "Add test files for feature <id>"

2. **Status Inconsistencies**
   - Source: `features.<id>.problems` where `code` relates to status
   - Examples:
     - `STATUS_DONE_BUT_MISSING_TESTS`: "Feature marked 'done' but has no tests"
     - `STATUS_DONE_BUT_MISSING_IMPLEMENTATION`: "Feature marked 'done' but has no implementation"

3. **Traceability Gaps**
   - Source: `features.<id>.problems` where `code` indicates gaps
   - Examples:
     - `MISSING_COMMITS`: "No commits reference feature <id> yet"
     - `ORPHAN_SPEC`: "Spec file exists but no implementation found"

### 5.2 Suggestion Structure

Each suggestion contains:

- **ID**: Unique identifier (deterministic, e.g., `commit-abc123-missing-feature-id`)
- **Type**: Category (`commit_format`, `feature_id`, `feature_traceability`, `summary`)
- **Severity**: `info`, `warning`, or `error` (mapped from report severity)
- **Message**: Human-readable description
- **Details**: Structured data (commit SHA, feature ID, violation code, etc.)
- **Fix**: Actionable guidance (optional, for v1)

### 5.3 Prioritization

Suggestions are prioritized by:

1. **Severity** (error > warning > info)
2. **Frequency** (more common issues first)
3. **Impact** (commits with multiple violations prioritized)
4. **Lexicographical order** (for determinism when priorities are equal)

---

## 6. Output Formats

### 6.1 Text Format

The text format provides a hierarchical, human-readable layout:

```
Commit Discipline Suggestions
============================

Errors (2)
----------
[E001] Commit abc123: Missing Feature ID
  Message: "feat: add deploy support"
  Fix: Add Feature ID in parentheses: feat(CLI_DEPLOY): add deploy support
  SHA: abc123

[E002] Commit def456: Invalid commit type
  Message: "feature(CLI_PLAN): implement plan"
  Fix: Use lowercase type: feat(CLI_PLAN): implement plan
  SHA: def456

Warnings (3)
------------
[W001] Commit ghi789: Summary too long
  Message: "feat(CLI_DEPLOY): add comprehensive deployment support with..."
  Fix: Shorten to ≤72 characters
  SHA: ghi789

...

Feature Traceability Suggestions
=================================

Errors (1)
----------
[E101] Feature CLI_DEPLOY: Missing tests
  Status: done
  Fix: Add test files for feature CLI_DEPLOY
  Spec: spec/commands/deploy.md

Warnings (2)
------------
[W101] Feature CLI_PLAN: No commits reference this feature
  Fix: Add Feature ID to commits: feat(CLI_PLAN): ...
  Spec: spec/commands/plan.md

...

Summary
=======
Total suggestions: 8
  Errors: 3
  Warnings: 4
  Info: 1
```

**Deterministic properties:**
- Suggestions grouped by severity (error, warning, info)
- Within each group, sorted by frequency, then lexicographically
- No timestamps
- No random ordering
- Consistent numbering (E001, E002, W001, etc.)

### 6.2 JSON Format

The JSON format provides a machine-readable encoding:

```json
{
  "schema_version": "1.0",
  "generated_at": "",
  "summary": {
    "total_suggestions": 8,
    "by_severity": {
      "error": 3,
      "warning": 4,
      "info": 1
    },
    "by_type": {
      "commit_format": 5,
      "feature_id": 2,
      "feature_traceability": 1
    }
  },
  "suggestions": [
    {
      "id": "commit-abc123-missing-feature-id",
      "type": "feature_id",
      "severity": "error",
      "message": "Commit abc123: Missing Feature ID",
      "details": {
        "commit_sha": "abc123",
        "violation_code": "MISSING_FEATURE_ID",
        "current_message": "feat: add deploy support"
      },
      "fix": {
        "action": "rewrite_commit",
        "suggested_message": "feat(CLI_DEPLOY): add deploy support",
        "command": "git commit --amend -m 'feat(CLI_DEPLOY): add deploy support'"
      }
    }
  ]
}
```

**Deterministic properties:**
- Suggestions array sorted by priority (severity, frequency, lexicographical)
- Details keys sorted lexicographically
- Schema is stable across v1 minor releases
- No timestamps in generated_at (empty string for determinism)

---

## 7. Error Handling

- All errors MUST be wrapped with context (per `CORE_LOGGING` and Go error wrapping conventions)
- CLI exit codes:
  - `0` – success
  - `1` – error occurred (missing reports, invalid JSON, I/O error)

- Common error classes:
  - Missing commit-health.json: "commit health report not found. Run 'stagecraft commit report' first."
  - Missing feature-traceability.json: "feature traceability report not found. Run 'stagecraft feature traceability' first."
  - Invalid JSON in reports: "invalid JSON in report: <path>: <error>"
  - Schema version mismatch: "unsupported report schema version: <version> (expected 1.0)"
  - I/O errors: "failed to read report: <path>: <error>"

- Error messages must be deterministic and actionable.

---

## 8. Determinism Requirements

All output MUST be deterministic:

- **No timestamps**: Output does not include timestamps or relative times
- **Sorted arrays**: All suggestion lists sorted by priority (severity, frequency, lexicographical)
- **Stable IDs**: Suggestion IDs are deterministic based on content (commit SHA + violation code)
- **Consistent formatting**: Text output uses fixed-width formatting, no variable spacing
- **No random ordering**: When priorities are equal, use lexicographical sort

This enables:
- Golden file testing
- Diff-based validation
- Reproducible CI/CD integration

---

## 9. Implementation Structure

### 9.1 Package Organization

- `internal/reports/suggestions/` (new package)
  - `suggestions.go`: Core suggestion generation logic
  - `suggestions_test.go`: Unit tests
  - `types.go`: Suggestion data types
  - `prioritize.go`: Prioritization logic

- `internal/cli/commands/commit_suggest.go`: Cobra command wiring
- `internal/cli/commands/commit_suggest_test.go`: CLI tests (golden files)

### 9.2 Core Logic

The suggestion generator:

1. **Reads reports**: Loads both JSON reports from `.stagecraft/reports/`
2. **Parses violations**: Extracts violations from commit-health.json
3. **Parses problems**: Extracts problems from feature-traceability.json
4. **Generates suggestions**: Creates suggestion objects from violations/problems
5. **Prioritizes**: Sorts suggestions by severity, frequency, impact
6. **Filters**: Applies --severity and --max-suggestions filters
7. **Formats**: Renders as text or JSON

### 9.3 Pure Functions

Core suggestion generation MUST be pure (no I/O):

- `GenerateSuggestions(commitReport, featureReport) ([]Suggestion, error)`
- `PrioritizeSuggestions(suggestions) []Suggestion`
- `FilterSuggestions(suggestions, minSeverity, maxCount) []Suggestion`
- `FormatSuggestionsText(suggestions) string`
- `FormatSuggestionsJSON(suggestions) ([]byte, error)`

This enables:
- Unit testing without filesystem
- Golden file testing
- Deterministic output

---

## 10. Testing Requirements

### 10.1 Unit Tests

- Test suggestion generation from sample reports
- Test prioritization logic (severity, frequency, lexicographical)
- Test filtering (severity threshold, max count)
- Test formatting (text and JSON)
- Test error handling (missing fields, invalid data)

### 10.2 Integration Tests

- Test reading real report files
- Test end-to-end: generate reports → run suggest → verify output
- Test error cases (missing reports, invalid JSON)

### 10.3 Golden Tests

Golden files MUST be used for:

- Text output format (deterministic text rendering)
- JSON output format (deterministic JSON structure)
- Suggestion prioritization (order verification)

**Golden file locations:**
- `internal/cli/commands/testdata/commit_suggest_text.golden`
- `internal/cli/commands/testdata/commit_suggest_json.golden`
- `internal/cli/commands/testdata/commit_suggest_filtered.golden`

**Golden file update:**
```bash
go test ./internal/cli/commands -run TestCommitSuggest -update
```

### 10.4 Test Data

Use deterministic test fixtures:

- Sample commit-health.json (from Phase 3.B tests)
- Sample feature-traceability.json (from Phase 3.B tests)
- Or generate minimal reports in tests

---

## 11. Examples

### 11.1 Basic Usage

```bash
$ stagecraft commit suggest

Commit Discipline Suggestions
============================

Errors (2)
----------
[E001] Commit abc123: Missing Feature ID
  Message: "feat: add deploy support"
  Fix: Add Feature ID in parentheses: feat(CLI_DEPLOY): add deploy support
  SHA: abc123

[E002] Commit def456: Summary too long
  Message: "feat(CLI_PLAN): implement comprehensive planning system with..."
  Fix: Shorten to ≤72 characters
  SHA: def456

Summary
=======
Total suggestions: 2
  Errors: 2
  Warnings: 0
  Info: 0
```

### 11.2 Filtered Output

```bash
$ stagecraft commit suggest --severity=error --max-suggestions=5

Commit Discipline Suggestions
============================

Errors (2)
----------
[E001] Commit abc123: Missing Feature ID
  ...
[E002] Commit def456: Summary too long
  ...
```

### 11.3 JSON Output

```bash
$ stagecraft commit suggest --format=json | jq '.summary'

{
  "total_suggestions": 8,
  "by_severity": {
    "error": 3,
    "warning": 4,
    "info": 1
  }
}
```

---

## 12. Integration with Phase 3.A–3.C

### 12.1 Report Dependencies

- **Phase 3.A**: Defines report schemas (commit-health.json, feature-traceability.json)
- **Phase 3.B**: Generates reports (pure generators)
- **Phase 3.C**: Writes reports via CLI commands
- **Phase 3.D**: Reads reports and generates suggestions (this spec)

### 12.2 Workflow

1. Developer runs `stagecraft commit report` → generates commit-health.json
2. Developer runs `stagecraft feature traceability` → generates feature-traceability.json
3. Developer runs `stagecraft commit suggest` → reads both reports, outputs suggestions
4. Developer fixes issues based on suggestions
5. Repeat from step 1

### 12.3 AI Integration

AI assistants (Cursor, ChatGPT) can:

1. Run `stagecraft commit suggest --format=json`
2. Parse JSON suggestions
3. Generate commit rewrite commands
4. Apply fixes automatically (future enhancement)

---

## 13. Future Enhancements

### 13.1 Automatic Fixes

- `--fix-commit <sha>`: Automatically rewrite a commit with suggested format
- `--fix-all`: Batch rewrite all invalid commits
- Interactive mode: `--interactive` for guided fixes

### 13.2 Enhanced Suggestions

- Per-feature suggestions: "Add tests for CLI_DEPLOY"
- Historical trends: "Commit discipline improved 20% this week"
- Team-level suggestions: "Most common violation: MISSING_FEATURE_ID"

### 13.3 CI/CD Integration

- Pre-commit hook integration
- PR comment generation
- Slack/email notifications

---

## 14. Non-Goals (Explicitly Out of Scope)

- Automatic commit rewriting (v1 is read-only suggestions)
- Git history modification
- Interactive prompts or wizards
- Integration with external tools (beyond reading reports)
- Real-time monitoring or webhooks

---

**Status**: `todo`  
**Next Steps**: Create analysis brief, then implementation outline, then agent promo for Phase 3.D implementation.

