#!/bin/bash
# Pre-commit hook for Stagecraft
#
# This hook runs basic checks before commits:
# - Format check (gofmt)
# - Lint check (if golangci-lint is available)
# - Run tests on changed packages
#
# To install:
#   ln -s ../../.hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Running pre-commit checks..."

# Get list of changed Go files
CHANGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$CHANGED_GO_FILES" ]; then
    echo "No Go files changed, skipping Go checks"
    exit 0
fi

# Check formatting
echo -n "Checking formatting... "
UNFORMATTED=$(echo "$CHANGED_GO_FILES" | xargs gofmt -l 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "The following files are not formatted:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: gofmt -w $UNFORMATTED"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# Check imports
echo -n "Checking imports... "
if command -v goimports &> /dev/null; then
    UNFORMATTED_IMPORTS=$(echo "$CHANGED_GO_FILES" | xargs goimports -l 2>/dev/null || true)
    if [ -n "$UNFORMATTED_IMPORTS" ]; then
        echo -e "${YELLOW}WARNING${NC}"
        echo "The following files have import issues:"
        echo "$UNFORMATTED_IMPORTS"
        echo "Run: goimports -w $UNFORMATTED_IMPORTS"
        # Don't fail, just warn
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${YELLOW}SKIPPED${NC} (goimports not installed)"
fi

# Run go vet on changed files
echo -n "Running go vet... "
VET_ERRORS=$(echo "$CHANGED_GO_FILES" | xargs go vet 2>&1 || true)
if [ -n "$VET_ERRORS" ]; then
    echo -e "${RED}FAILED${NC}"
    echo "$VET_ERRORS"
    exit 1
fi
echo -e "${GREEN}OK${NC}"

# Run tests on changed packages (if test files exist)
echo -n "Running tests on changed packages... "
CHANGED_PACKAGES=$(echo "$CHANGED_GO_FILES" | sed 's|/[^/]*$||' | sort -u | grep -v '^$' || true)

if [ -z "$CHANGED_PACKAGES" ]; then
    echo -e "${YELLOW}SKIPPED${NC} (no packages to test)"
else
    FAILED_TESTS=""
    for pkg in $CHANGED_PACKAGES; do
        # Only test if package has test files
        if find "$pkg" -name "*_test.go" 2>/dev/null | grep -q .; then
            if ! go test "$pkg" -short 2>&1; then
                FAILED_TESTS="$FAILED_TESTS $pkg"
            fi
        fi
    done
    
    if [ -n "$FAILED_TESTS" ]; then
        echo -e "${RED}FAILED${NC}"
        echo "Tests failed in:$FAILED_TESTS"
        exit 1
    fi
    echo -e "${GREEN}OK${NC}"
fi

# Optional: Run golangci-lint if available
if command -v golangci-lint &> /dev/null; then
    echo -n "Running golangci-lint... "
    if echo "$CHANGED_GO_FILES" | xargs golangci-lint run --files 2>&1 | grep -q "issues found"; then
        echo -e "${YELLOW}WARNING${NC}"
        echo "golangci-lint found issues. Review and fix before committing."
        # Don't fail, just warn (CI will catch it)
    else
        echo -e "${GREEN}OK${NC}"
    fi
else
    echo -e "${YELLOW}SKIPPED${NC} (golangci-lint not installed)"
fi

echo -e "${GREEN}Pre-commit checks passed!${NC}"
exit 0

