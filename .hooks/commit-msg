#!/usr/bin/env bash
# SPDX-License-Identifier: AGPL-3.0-or-later
#
# Stagecraft - Stagecraft is a Go-based CLI that orchestrates local-first development and scalable single-host to multi-host deployments for multi-service applications powered by Docker Compose.
#
# Copyright (C) 2025  Bartek Kus
#
# This program is free software licensed under the terms of the GNU AGPL v3 or later.
#
# See https://www.gnu.org/licenses/ for license details.
#
# Commit-msg hook: Validates commit message format
#
# Expected format:
#   <type>(<FEATURE_ID>): <summary>
#
#   Longer explanation if needed.
#   Spec: spec/<...>.md
#   Tests: <paths>
#
# Escape hatch: Set STAGECRAFT_SKIP_HOOKS=1 to bypass

set -e

# Escape hatch
if [ "${STAGECRAFT_SKIP_HOOKS:-}" = "1" ] || [ "${SKIP_HOOKS:-}" = "1" ]; then
    exit 0
fi

COMMIT_MSG_FILE="$1"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() {
    echo -e "${RED}✗${NC} $1" >&2
}

info() {
    echo -e "${GREEN}✓${NC} $1"
}

# Read commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Extract first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)

# Check if subject matches format: <type>(<FEATURE_ID>): <summary>
# Allowed types: feat, fix, refactor, docs, test, ci, chore
if ! echo "$SUBJECT" | grep -qE '^(feat|fix|refactor|docs|test|ci|chore)\([A-Z][A-Z0-9_]+\): .+'; then
    error "Invalid commit message format"
    echo ""
    echo "Expected format:"
    echo "  <type>(<FEATURE_ID>): <summary>"
    echo ""
    echo "Allowed types: feat, fix, refactor, docs, test, ci, chore"
    echo "FEATURE_ID must be SCREAMING_SNAKE_CASE"
    echo ""
    echo "Examples:"
    echo "  feat(CLI_PLAN): Add plan command"
    echo "  fix(CORE_CONFIG): Fix config loading bug"
    echo "  docs(ARCH): Update architecture docs"
    echo ""
    echo "Your message:"
    echo "  $SUBJECT"
    echo ""
    echo "To bypass this check: STAGECRAFT_SKIP_HOOKS=1 git commit"
    exit 1
fi

# Extract FEATURE_ID
FEATURE_ID=$(echo "$SUBJECT" | sed -nE 's/^[^(]+\(([^)]+)\):.*/\1/p')

# Validate FEATURE_ID format (SCREAMING_SNAKE_CASE)
if ! echo "$FEATURE_ID" | grep -qE '^[A-Z][A-Z0-9_]*$'; then
    error "Invalid FEATURE_ID format: $FEATURE_ID"
    echo ""
    echo "FEATURE_ID must be in SCREAMING_SNAKE_CASE (e.g., CLI_PLAN, CORE_CONFIG)"
    exit 1
fi

# Check subject length (should be ≤ 72 characters)
SUBJECT_LEN=${#SUBJECT}
if [ $SUBJECT_LEN -gt 72 ]; then
    error "Commit subject too long: $SUBJECT_LEN characters (max 72)"
    echo ""
    echo "Subject: $SUBJECT"
    exit 1
fi

# Check for trailing period in subject
if echo "$SUBJECT" | grep -qE '\.$'; then
    error "Commit subject should not end with a period"
    echo ""
    echo "Subject: $SUBJECT"
    exit 1
fi

info "Commit message format valid: $SUBJECT"
exit 0

