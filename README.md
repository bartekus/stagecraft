# Stagecraft

<p align="center">
  <img src="https://img.shields.io/badge/License-AGPL_v3%2B-blue.svg" alt="AGPL-3.0-or-later" />
  <a href="https://github.com/bartekus/stagecraft/actions/workflows/governance.yml"><img src="https://github.com/bartekus/stagecraft/actions/workflows/governance.yml/badge.svg" alt="Governance Status" /></a>
</p>

Stagecraft is a Go-based CLI that orchestrates local-first development and scalable single-host to multi-host deployments for multi-service applications powered by Docker Compose.

- **Local-first DX** ‚Äì one command to spin up full local infra, HTTPS, backend, and frontend.
- **Compose + docker-rollout** ‚Äì predictable runtime orchestration.
- **Mesh networking by default** ‚Äì Tailscale or Headscale for single-host ‚Üí multi-host evolution.
- **Provider model** ‚Äì Generic or Encore.ts backend, Generic or Vite, DigitalOcean, GitHub Actions and others plug in cleanly.
- **Configuration-driven** ‚Äì one `stagecraft.yml` plus a canonical `docker-compose.yml`.

> ‚ö†Ô∏è **Status**: Early WIP / experimental. Core commands (`dev`, `migrate`, `build`, `deploy`, `plan`, `rollback`, `releases`, `init`, `infra up`) are functional. See [Implementation Status](docs/engine/status/implementation-status.md) for details.

---

## Goals

- Make it trivial to go from:
    - `docker compose up` on a laptop  
      to
    - a small multi-host deployment on a single VM or a handful of nodes.
- Treat:
    - **Encore.ts** as the default backend provider.
    - **Vite (or similar)** as the frontend dev provider.
- Provide a **smooth path**:
    - single host ‚Üí multi host,
    - local dev ‚Üí staging ‚Üí production,
    - without switching tools or mental models.

For full details, see [`docs/narrative/stagecraft-spec.md`](docs/narrative/stagecraft-spec.md).

---

## Quickstart: basic Node app

The easiest way to get started is with the `examples/basic-node` example:

```bash
# Clone the repository
git clone https://github.com/bartekus/stagecraft.git
cd stagecraft

# Build Stagecraft
go build ./cmd/stagecraft

# Try the example
cd examples/basic-node

# Start dev backend (runs npm run dev in ./backend)
./stagecraft dev

# In another terminal, apply database migrations
export DATABASE_URL="postgres://user:pass@localhost/dbname"
./stagecraft migrate

# Or preview migrations without executing
./stagecraft migrate --plan
```

The example uses:
- **Backend provider**: `generic` ‚Äì runs `npm run dev` in the `./backend` directory
- **Migration engine**: `raw` ‚Äì executes SQL files from `./migrations` in order

See `examples/basic-node/stagecraft.yml` for the configuration:

```yaml
backend:
  provider: generic
  providers:
    generic:
      dev:
        command: ["npm", "run", "dev"]
        workdir: "./backend"

databases:
  main:
    connection_env: DATABASE_URL
    migrations:
      engine: raw
      path: ./migrations
      strategy: pre_deploy
```

This demonstrates Stagecraft's provider-agnostic architecture: you can use any backend framework and any migration tool, all configured through a single `stagecraft.yml` file.

---

## High-level architecture

Stagecraft is built around a few core ideas:

- **Config file**: `stagecraft.yml` describes:
    - environments (`dev`, `staging`, `prod`),
    - host roles and mappings,
    - providers (backend, frontend, network, cloud, CI, secrets),
    - environment-specific details (TLS mode, ports, volumes, etc.).
- **Canonical `docker-compose.yml`**:
    - One service graph for infra + app.
    - Environment differences handled via env vars and small override files generated by Stagecraft.
- **Providers**:
    - `BackendProvider` ‚Äì e.g. Encore.ts (dev server + Docker builds).
    - `FrontendProvider` ‚Äì e.g. ‚Äúrun this dev command in this directory‚Äù (Vite etc.).
    - `NetworkProvider` ‚Äì Tailscale/Headscale for multi-host routing.
    - `CloudProvider` ‚Äì DigitalOcean CLI first, then others.
    - `CIProvider` ‚Äì GitHub Actions (`gh`) first.
- **Mesh networking**:
    - Each host joins a Tailscale/Headscale tailnet.
    - Services communicate via Tailscale DNS, even across hosts.

---

## Commands

### Implemented ‚úÖ

- `stagecraft dev`  
  Start development environment using the configured backend provider.
  - Loads `stagecraft.yml` and resolves backend provider from registry
  - Delegates to provider's `Dev()` method
  - Streams output to terminal
  - Supports `--config` flag to specify config file path
  - Supports `--verbose` flag for detailed logging

- `stagecraft migrate`  
  Run database migrations using the configured migration engine.
  - Supports `--plan` flag for dry-run mode
  - Supports `--database <name>` to select database
  - Supports `--config` flag to specify config file path
  - Delegates to engine's `Plan()` or `Run()` methods

- `stagecraft init`  
  Bootstrap Stagecraft into the current project.
  - Creates `stagecraft.yml` configuration file
  - Sets up project structure

- `stagecraft build`  
  Build Docker images using backend/frontend providers and push to registry.

- `stagecraft deploy`  
  Deploy a given version to an environment:
    - Generate per-host Compose configs based on roles
    - Roll out containers using docker-rollout
    - Track release history

- `stagecraft plan`  
  Show the deployment plan without executing it (dry-run mode).

- `stagecraft rollback`  
  Roll back an environment to a previous version (based on tracked release history).

- `stagecraft releases`  
  List and show deployment release history.

- `stagecraft infra up`  
  Create infrastructure for an environment using CloudProvider (DigitalOcean CLI).

- `stagecraft commit suggest`  
  Generate commit discipline suggestions based on governance rules.

- `stagecraft gov`  
  Governance checks for Stagecraft (feature mapping, validation, etc.).

- `stagecraft context build`  
  Build AI-readable context representation in `.ai-context/`

- `stagecraft context xray`  
  Run XRAY scan to analyze repository structure and dependencies

### Planned / In Progress

- `stagecraft dev` (full feature set)  
  Run full local dev:
    - Docker Compose infra (Traefik, Postgres, Redis, Logto, etc.).
    - Encore dev server (with secrets synced from `.env.local`).
    - Frontend dev server (e.g. Vite).
    - Local HTTPS via mkcert + Traefik.

- `stagecraft infra down`  
  Destroy infrastructure for an environment using CloudProvider.

- `stagecraft ci init` / `stagecraft ci run`  
  Initialize CI pipelines (e.g. GitHub Actions) and trigger runs from the CLI.

- `stagecraft status`  
  Show container/health status for an environment.

- `stagecraft logs`  
  Tail logs for a service in an environment.

- `stagecraft ssh`  
  Open SSH (or `tailscale ssh`) to a host/role.

- `stagecraft secrets sync`  
  Sync secrets between `.env`/config and providers (Encore dev secrets, `/etc/platform/env`, etc.).

See the spec for deeper behavior of each command.

---

## AI Context Pipeline

Stagecraft uses a deterministic local context compiler to build AI-readable
representations of the repository.

**Commands:**
- `stagecraft context build` - Builds `.ai-context/` directory
- `stagecraft context xray` - Runs XRAY scan for repository analysis

**Outputs:**
- `.ai-context/` - Gitignored, deterministic AI context representation
- `.xraycache/` - Gitignored, cache only

**Important:**
- No data leaves the machine
- No embeddings or vector databases
- No backend or network calls
- Pure local processing

---

## Project structure

Current structure:

```text
stagecraft/
  cmd/
    stagecraft/            # Main CLI entry point
    feature-dashboard/     # Feature governance dashboard tool
    spec-reference-check/ # Spec reference validation tool
    gen-features-overview/ # Feature overview generator
    ...                    # Other utility tools
  internal/
    cli/commands/          # CLI command implementations
      dev.go
      migrate.go
      build.go
      deploy.go
      plan.go
      rollback.go
      releases.go
      init.go
      infra_up.go
      commit_suggest.go
      gov.go
      ...
    core/                  # Core planning and state management
    providers/             # Provider implementations
      backend/generic/
      backend/encorets/
      frontend/generic/
      network/tailscale/
      cloud/digitalocean/
      migration/raw/
      ...
  pkg/
    config/                # Config loading and validation
    providers/             # Provider interfaces and registries
      backend/
      frontend/
      network/
      cloud/
      ci/
      migration/
      secrets/
    executil/              # Process execution helpers
    logging/               # Structured logging helpers
  spec/                    # Feature specifications (source of truth)
    commands/
    core/
    providers/
    features.yaml          # Feature registry
  docs/                    # Documentation
    engine/                # Implementation-aligned technical docs
      analysis/            # Feature analysis briefs
      outlines/            # Implementation outlines
      status/              # Generated status tracking
      history/             # Feature evolution logs
      agents/              # Agent briefs
    narrative/             # Human-facing planning docs
    governance/            # Process and workflow docs
    coverage/              # Coverage tracking
    archive/               # Historical, archived docs
  scripts/                 # Utility scripts
  examples/                # Example projects
    basic-node/
  test/e2e/                # End-to-end tests
  go.mod
  LICENSE
  README.md
  Agent.md                 # Development guidelines
```

For detailed documentation structure, see [`docs/README.md`](docs/README.md).

## Building & running

### Prerequisites
- Go 1.22+ (or recent stable).
- Docker (for future dev/deploy functionality).
- PostgreSQL (for migration examples).

### Build from source
```bash
git clone https://github.com/bartekus/stagecraft.git
cd stagecraft
go build ./cmd/stagecraft
```

### Try it out
```bash
# See available commands
./stagecraft --help

# Try the basic-node example
cd examples/basic-node
./stagecraft dev
```

## Implementation roadmap & status

For detailed feature status, see:
- **[Implementation Status](docs/engine/status/implementation-status.md)** - Auto-generated from `spec/features.yaml`
- **[Implementation Roadmap](docs/narrative/implementation-roadmap.md)** - Detailed feature catalog and phases
- **[Feature Overview](docs/features/OVERVIEW.md)** - Generated feature summary

### Key Completed Features

**Core Infrastructure:**
- ‚úÖ Cobra root command with global flags (`--env`, `--config`, `--verbose`, `--dry-run`)
- ‚úÖ Config loader for `stagecraft.yml` (`pkg/config`)
- ‚úÖ Structured logging (`pkg/logging`)
- ‚úÖ Process execution utilities (`pkg/executil`)

**Providers:**
- ‚úÖ BackendProvider interface + Generic and Encore.ts implementations
- ‚úÖ FrontendProvider interface + Generic implementation
- ‚úÖ NetworkProvider interface + Tailscale implementation
- ‚úÖ CloudProvider interface + DigitalOcean implementation
- ‚úÖ Migration engine interface + Raw SQL implementation

**Commands:**
- ‚úÖ `stagecraft dev` - Development environment
- ‚úÖ `stagecraft migrate` - Database migrations
- ‚úÖ `stagecraft build` - Docker image builds
- ‚úÖ `stagecraft deploy` - Environment deployment
- ‚úÖ `stagecraft plan` - Dry-run planning
- ‚úÖ `stagecraft rollback` - Rollback to previous version
- ‚úÖ `stagecraft releases` - Release history
- ‚úÖ `stagecraft init` - Project bootstrap
- ‚úÖ `stagecraft infra up` - Infrastructure provisioning
- ‚úÖ `stagecraft commit suggest` - Commit discipline suggestions
- ‚úÖ `stagecraft gov` - Governance checks

**Governance:**
- ‚úÖ Feature mapping validation
- ‚úÖ Spec reference checking
- ‚úÖ Provider coverage enforcement
- ‚úÖ Commit message discipline

### In Progress / Planned

- üîÑ Full `stagecraft dev` feature set (Docker Compose infra, HTTPS, frontend dev server)
- üìã `stagecraft infra down` - Infrastructure teardown
- üìã `stagecraft ci init` / `stagecraft ci run` - CI pipeline management
- üìã `stagecraft status` - Container/health status
- üìã `stagecraft logs` - Service log tailing
- üìã `stagecraft ssh` - Host access
- üìã `stagecraft secrets sync` - Secret synchronization


## Contributing / Development

Right now this is experimental and evolving quickly.

### Development Setup

1. **Clone and build:**
   ```bash
   git clone https://github.com/bartekus/stagecraft.git
   cd stagecraft
   go build ./cmd/stagecraft
   ```

2. **Install git hooks:**
   ```bash
   ./scripts/install-hooks.sh
   ```

3. **Run tests:**
   ```bash
   go test ./...
   ```

4. **Check coverage:**
   ```bash
   ./scripts/check-coverage.sh
   ```

5. **Validate specs:**
   ```bash
   ./scripts/validate-spec.sh
   ```

### Development Workflow

1. **Spec-first**: Before implementing, update or create specs in `spec/`
2. **Test-first**: Write tests before implementation (especially for core logic)
3. **Update features.yaml**: Track feature status in `spec/features.yaml`
4. **Run pre-commit checks**: Hooks will validate formatting, tests, etc.
5. **Update docs**: Keep `docs/` and `spec/` in sync with code changes

### Code Quality Standards

- All code must pass `gofmt`, `go vet`, and `golangci-lint`
- Core packages (`pkg/config`, `internal/core`) require 80%+ test coverage
- All features must have specs and tests before marking as `done`
- See [Agent.md](Agent.md) for detailed development guidelines

### Documentation

- **Specs**: `spec/` - Feature specifications (source of truth)
- **Architecture**: [`docs/narrative/architecture.md`](docs/narrative/architecture.md) - System design
- **ADRs**: `spec/adr/` - Architecture Decision Records
- **Implementation Status**: [`docs/engine/status/implementation-status.md`](docs/engine/status/implementation-status.md) - Feature progress (auto-generated)
- **Getting Started**: [`docs/guides/getting-started.md`](docs/guides/getting-started.md) - User guide

**Further Documentation**:
- **[docs/README.md](docs/README.md)** - Complete documentation index and navigation guide
- **[docs/engine/engine-index.md](docs/engine/engine-index.md)** - Quick reference for which docs to open per feature type
- **[scripts/README.md](scripts/README.md)** - Utility scripts reference and usage guide
- **[docs/narrative/stagecraft-spec.md](docs/narrative/stagecraft-spec.md)** - Specification index
- **[docs/narrative/implementation-roadmap.md](docs/narrative/implementation-roadmap.md)** - Detailed implementation roadmap

**Canonical Documentation**:
- **[docs/governance/GOVERNANCE_ALMANAC.md](docs/governance/GOVERNANCE_ALMANAC.md)** - Governance rules and processes
- **[docs/coverage/COVERAGE_LEDGER.md](docs/coverage/COVERAGE_LEDGER.md)** - Test coverage tracking
- **[docs/context-handoff/CONTEXT_LOG.md](docs/context-handoff/CONTEXT_LOG.md)** - Context handoff log
- **[docs/engine/history/*_EVOLUTION.md](docs/engine/history/)** - Feature evolution logs

For more details, see:
- [Agent.md](Agent.md) - Development guidelines and protocol
- [docs/engine/status/implementation-status.md](docs/engine/status/implementation-status.md) - Feature tracking



