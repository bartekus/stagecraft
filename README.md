# Stagecraft

Stagecraft is a Go-based orchestration CLI for local development and deployment of multi-service applications.

It aims to be a “Kamal, but for Docker Compose + Tailscale + Encore.ts + Vite”:

- **Local-first DX** – one command to spin up full local infra, HTTPS, backend, and frontend.
- **Compose + docker-rollout** – predictable runtime orchestration.
- **Mesh networking by default** – Tailscale or Headscale for single-host → multi-host evolution.
- **Provider model** – Encore.ts, Vite, DigitalOcean, GitHub Actions and others plug in cleanly.
- **Configuration-driven** – one `stagecraft.yml` plus a canonical `docker-compose.yml`.

> ⚠️ **Status**: Early WIP / experimental. Right now only the Cobra skeleton exists; most features are not implemented yet.

---

## Goals

- Make it trivial to go from:
    - `docker compose up` on a laptop  
      to
    - a small multi-host deployment on a single VM or a handful of nodes.
- Treat:
    - **Encore.ts** as the default backend provider.
    - **Vite (or similar)** as the frontend dev provider.
- Provide a **smooth path**:
    - single host → multi host,
    - local dev → staging → production,
    - without switching tools or mental models.

For full details, see [`docs/stagecraft-spec.md`](docs/stagecraft-spec.md).

---

## Quickstart: basic Node app

The easiest way to get started is with the `examples/basic-node` example:

```bash
# Clone the repository
git clone https://github.com/your-org/stagecraft.git
cd stagecraft

# Build Stagecraft
go build ./cmd/stagecraft

# Try the example
cd examples/basic-node

# Start dev backend
./stagecraft dev

# In another terminal, apply database migrations
export DATABASE_URL="postgres://user:pass@localhost/dbname"
./stagecraft migrate
```

The example uses:
- **Backend provider**: `generic` – runs `npm run dev` in the `./backend` directory
- **Migration engine**: `raw` – executes SQL files from `./migrations` in order

See `examples/basic-node/stagecraft.yml` for the configuration:

```yaml
backend:
  provider: generic
  providers:
    generic:
      dev:
        command: ["npm", "run", "dev"]
        workdir: "./backend"

databases:
  main:
    connection_env: DATABASE_URL
    migrations:
      engine: raw
      path: ./migrations
```

This demonstrates Stagecraft's provider-agnostic architecture: you can use any backend framework and any migration tool, all configured through a single `stagecraft.yml` file.

---

## High-level architecture

Stagecraft is built around a few core ideas:

- **Config file**: `stagecraft.yml` describes:
    - environments (`dev`, `staging`, `prod`),
    - host roles and mappings,
    - providers (backend, frontend, network, cloud, CI, secrets),
    - environment-specific details (TLS mode, ports, volumes, etc.).
- **Canonical `docker-compose.yml`**:
    - One service graph for infra + app.
    - Environment differences handled via env vars and small override files generated by Stagecraft.
- **Providers**:
    - `BackendProvider` – e.g. Encore.ts (dev server + Docker builds).
    - `FrontendProvider` – e.g. “run this dev command in this directory” (Vite etc.).
    - `NetworkProvider` – Tailscale/Headscale for multi-host routing.
    - `CloudProvider` – DigitalOcean CLI first, then others.
    - `CIProvider` – GitHub Actions (`gh`) first.
- **Mesh networking**:
    - Each host joins a Tailscale/Headscale tailnet.
    - Services communicate via Tailscale DNS, even across hosts.

---

## Planned commands

_None of these are fully implemented yet – this is the target design._

- `stagecraft init`  
  Scaffold `stagecraft.yml`, optional `docker-compose.yml`, and basic app layout.

- `stagecraft dev`  
  Run full local dev:
    - Docker Compose infra (Traefik, Postgres, Redis, Logto, etc.).
    - Encore dev server (with secrets synced from `.env.local`).
    - Frontend dev server (e.g. Vite).
    - Local HTTPS via mkcert + Traefik.

- `stagecraft build`  
  Build Docker images (primarily in CI) using backend/frontend providers and push to registry.

- `stagecraft deploy`  
  Deploy a given version to an environment:
    - Ensure hosts are reachable and on the mesh.
    - Generate per-host Compose configs.
    - Roll out containers using docker-rollout.

- `stagecraft rollback`  
  Roll back an environment to a previous version (based on tracked release history).

- `stagecraft infra up` / `stagecraft infra down`  
  Create/destroy infrastructure for an environment using a CloudProvider (DigitalOcean CLI first).

- `stagecraft ci init` / `stagecraft ci run`  
  Initialize CI pipelines (e.g. GitHub Actions) and trigger runs from the CLI.

- `stagecraft status`  
  Show container/health status for an environment.

- `stagecraft logs`  
  Tail logs for a service in an environment.

- `stagecraft ssh`  
  Open SSH (or `tailscale ssh`) to a host/role.

- `stagecraft secrets sync`  
  Sync secrets between `.env`/config and providers (Encore dev secrets, `/etc/platform/env`, etc.).

See the spec for deeper behavior of each command.

---

## Project structure

Current:

```text
stagecraft/
  cmd/
    root.go                # Cobra root command
  docs/
    stagecraft-spec.md     # Design/spec document
  main.go                  # Entry point: calls cmd.Execute()
  go.mod
  go.sum
  LICENSE
  README.md
```

Target (as features are implemented):
```text
stagecraft/
  cmd/
    root.go
    dev.go
    deploy.go
    init.go
    infra.go
    ci.go
    status.go
    logs.go
    ssh.go
    rollback.go
  docs/
    stagecraft-spec.md
  pkg/
    config/                # Load & validate stagecraft.yml
    compose/               # Compose helpers and override generation
    dev/                   # `stagecraft dev` orchestration
    deploy/                # build/deploy/rollback orchestration
    infra/                 # infra up/down workflows
    ci/                    # CI provider coordination
    providers/
      backend/
      frontend/
      network/
      cloud/
      ci/
      secrets/
    executil/              # process execution/log streaming helpers
    logging/               # structured logging helpers
```

Building & running

Right now, Stagecraft only has the root command. Once more commands are added, this section will be expanded with real usage examples.

Prerequisites
•	Go 1.22+ (or recent stable).
•	Docker (for future dev/deploy functionality).

Build from source
```bash
git clone https://github.com/your-org/stagecraft.git
cd stagecraft
go build ./...
```

```bash
./stagecraft --help
```

## Implementation roadmap & status

This section is meant to stay in sync with the spec and act as a high-level checklist.

Scaffolding & core
    •	Cobra root command (stagecraft). []
    •	Global flags (--env, --config, --verbose, --dry-run). []
    •	Config loader for stagecraft.yml (pkg/config). []
    •	Basic structured logging helper (pkg/logging). []
    •	Exec utilities for running external commands (pkg/executil). []

Providers
    •	BackendProvider interface + Encore.ts implementation. []
    •	FrontendProvider interface + generic dev command implementation. []
    •	NetworkProvider interface + Tailscale implementation. []
    •	CloudProvider interface + DigitalOcean implementation. []
    •	CIProvider interface + GitHub Actions implementation. []
    •	SecretsProvider abstraction (env, Encore dev secrets, etc.). []

Local dev (stagecraft dev)
    •	mkcert integration / local HTTPS setup. []
    •	/etc/hosts management for local dev domains. []
    •	Traefik dev config generation (file provider, dynamic config). []
    •	Compose infra up/down for dev environment. []
    •	Encore dev flow:
        •	Load .env.local. []
        •	Sync secrets via encore secret set. []
        •	Run encore run --watch --listen 0.0.0.0:4000. []
    •	Frontend dev process (Vite or other). []
    •	Connected dev mode via Tailscale (optional). []

Build & deploy
    •	stagecraft build:
        •	Backend Docker image via encore build docker. []
        •	Frontend image build (optional). []
        •	Push to registry. []
    •	stagecraft deploy:
        •	Per-host Compose generation based on roles. []
        •	Tailscale join/verification on hosts. []
        •	docker-rollout integration. []
        •	Simple release history tracking (version per env). []
    •	stagecraft rollback:
        •	Lookup previous version. []
        •	Re-deploy that version. []

Infra & CI
    •	stagecraft infra up / infra down using DO CLI. []
    •	stagecraft ci init to scaffold GitHub Actions workflow. []
    •	stagecraft ci run to trigger CI runs. []

Ops UX
    •	stagecraft status (per env/host/service). []
    •	stagecraft logs (per service/env). []
    •	stagecraft ssh (per host/role). []


## Contributing / Development

Right now this is experimental and evolving quickly.

### Development Setup

1. **Clone and build:**
   ```bash
   git clone https://github.com/your-org/stagecraft.git
   cd stagecraft
   go build ./cmd/stagecraft
   ```

2. **Install git hooks:**
   ```bash
   ./scripts/install-hooks.sh
   ```

3. **Run tests:**
   ```bash
   go test ./...
   ```

4. **Check coverage:**
   ```bash
   ./scripts/check-coverage.sh
   ```

5. **Validate specs:**
   ```bash
   ./scripts/validate-spec.sh
   ```

### Development Workflow

1. **Spec-first**: Before implementing, update or create specs in `spec/`
2. **Test-first**: Write tests before implementation (especially for core logic)
3. **Update features.yaml**: Track feature status in `spec/features.yaml`
4. **Run pre-commit checks**: Hooks will validate formatting, tests, etc.
5. **Update docs**: Keep `docs/` and `spec/` in sync with code changes

### Code Quality Standards

- All code must pass `gofmt`, `go vet`, and `golangci-lint`
- Core packages (`pkg/config`, `internal/core`) require 80%+ test coverage
- All features must have specs and tests before marking as `done`
- See [Agent.md](Agent.md) for detailed development guidelines

### Documentation

- **Specs**: `spec/` - Feature specifications
- **Architecture**: `docs/architecture.md` - System design
- **ADRs**: `docs/adr/` - Architecture Decision Records
- **Implementation Status**: `docs/implementation-status.md` - Feature progress
- **Getting Started**: `docs/guides/getting-started.md` - User guide

For more details, see:
- [Agent.md](Agent.md) - Development guidelines
- [docs/implementation-status.md](docs/implementation-status.md) - Feature tracking



