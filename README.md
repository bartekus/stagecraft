# Stagecraft

Stagecraft is a Go-based orchestration CLI for local development and deployment of multi-service applications.

It aims to be a “Kamal, but for Docker Compose + Tailscale + Encore.ts + Vite”:

- **Local-first DX** – one command to spin up full local infra, HTTPS, backend, and frontend.
- **Compose + docker-rollout** – predictable runtime orchestration.
- **Mesh networking by default** – Tailscale or Headscale for single-host → multi-host evolution.
- **Provider model** – Encore.ts, Vite, DigitalOcean, GitHub Actions and others plug in cleanly.
- **Configuration-driven** – one `stagecraft.yml` plus a canonical `docker-compose.yml`.

> ⚠️ **Status**: Early WIP / experimental. Right now only the Cobra skeleton exists; most features are not implemented yet.

---

## Goals

- Make it trivial to go from:
    - `docker compose up` on a laptop  
      to
    - a small multi-host deployment on a single VM or a handful of nodes.
- Treat:
    - **Encore.ts** as the default backend provider.
    - **Vite (or similar)** as the frontend dev provider.
- Provide a **smooth path**:
    - single host → multi host,
    - local dev → staging → production,
    - without switching tools or mental models.

For full details, see [`docs/stagecraft-spec.md`](docs/stagecraft-spec.md).

---

## High-level architecture

Stagecraft is built around a few core ideas:

- **Config file**: `stagecraft.yml` describes:
    - environments (`dev`, `staging`, `prod`),
    - host roles and mappings,
    - providers (backend, frontend, network, cloud, CI, secrets),
    - environment-specific details (TLS mode, ports, volumes, etc.).
- **Canonical `docker-compose.yml`**:
    - One service graph for infra + app.
    - Environment differences handled via env vars and small override files generated by Stagecraft.
- **Providers**:
    - `BackendProvider` – e.g. Encore.ts (dev server + Docker builds).
    - `FrontendProvider` – e.g. “run this dev command in this directory” (Vite etc.).
    - `NetworkProvider` – Tailscale/Headscale for multi-host routing.
    - `CloudProvider` – DigitalOcean CLI first, then others.
    - `CIProvider` – GitHub Actions (`gh`) first.
- **Mesh networking**:
    - Each host joins a Tailscale/Headscale tailnet.
    - Services communicate via Tailscale DNS, even across hosts.

---

## Planned commands

_None of these are fully implemented yet – this is the target design._

- `stagecraft init`  
  Scaffold `stagecraft.yml`, optional `docker-compose.yml`, and basic app layout.

- `stagecraft dev`  
  Run full local dev:
    - Docker Compose infra (Traefik, Postgres, Redis, Logto, etc.).
    - Encore dev server (with secrets synced from `.env.local`).
    - Frontend dev server (e.g. Vite).
    - Local HTTPS via mkcert + Traefik.

- `stagecraft build`  
  Build Docker images (primarily in CI) using backend/frontend providers and push to registry.

- `stagecraft deploy`  
  Deploy a given version to an environment:
    - Ensure hosts are reachable and on the mesh.
    - Generate per-host Compose configs.
    - Roll out containers using docker-rollout.

- `stagecraft rollback`  
  Roll back an environment to a previous version (based on tracked release history).

- `stagecraft infra up` / `stagecraft infra down`  
  Create/destroy infrastructure for an environment using a CloudProvider (DigitalOcean CLI first).

- `stagecraft ci init` / `stagecraft ci run`  
  Initialize CI pipelines (e.g. GitHub Actions) and trigger runs from the CLI.

- `stagecraft status`  
  Show container/health status for an environment.

- `stagecraft logs`  
  Tail logs for a service in an environment.

- `stagecraft ssh`  
  Open SSH (or `tailscale ssh`) to a host/role.

- `stagecraft secrets sync`  
  Sync secrets between `.env`/config and providers (Encore dev secrets, `/etc/platform/env`, etc.).

See the spec for deeper behavior of each command.

---

## Project structure

Current:

```text
stagecraft/
  cmd/
    root.go                # Cobra root command
  docs/
    stagecraft-spec.md     # Design/spec document
  main.go                  # Entry point: calls cmd.Execute()
  go.mod
  go.sum
  LICENSE
  README.md
```

Target (as features are implemented):
```text
stagecraft/
  cmd/
    root.go
    dev.go
    deploy.go
    init.go
    infra.go
    ci.go
    status.go
    logs.go
    ssh.go
    rollback.go
  docs/
    stagecraft-spec.md
  pkg/
    config/                # Load & validate stagecraft.yml
    compose/               # Compose helpers and override generation
    dev/                   # `stagecraft dev` orchestration
    deploy/                # build/deploy/rollback orchestration
    infra/                 # infra up/down workflows
    ci/                    # CI provider coordination
    providers/
      backend/
      frontend/
      network/
      cloud/
      ci/
      secrets/
    executil/              # process execution/log streaming helpers
    logging/               # structured logging helpers
```

Building & running

Right now, Stagecraft only has the root command. Once more commands are added, this section will be expanded with real usage examples.

Prerequisites
•	Go 1.22+ (or recent stable).
•	Docker (for future dev/deploy functionality).

Build from source
```bash
git clone https://github.com/your-org/stagecraft.git
cd stagecraft
go build ./...
```

```bash
./stagecraft --help
```

## Implementation roadmap & status

This section is meant to stay in sync with the spec and act as a high-level checklist.

Scaffolding & core
    •	Cobra root command (stagecraft). []
    •	Global flags (--env, --config, --verbose, --dry-run). []
    •	Config loader for stagecraft.yml (pkg/config). []
    •	Basic structured logging helper (pkg/logging). []
    •	Exec utilities for running external commands (pkg/executil). []

Providers
    •	BackendProvider interface + Encore.ts implementation. []
    •	FrontendProvider interface + generic dev command implementation. []
    •	NetworkProvider interface + Tailscale implementation. []
    •	CloudProvider interface + DigitalOcean implementation. []
    •	CIProvider interface + GitHub Actions implementation. []
    •	SecretsProvider abstraction (env, Encore dev secrets, etc.). []

Local dev (stagecraft dev)
    •	mkcert integration / local HTTPS setup. []
    •	/etc/hosts management for local dev domains. []
    •	Traefik dev config generation (file provider, dynamic config). []
    •	Compose infra up/down for dev environment. []
    •	Encore dev flow:
        •	Load .env.local. []
        •	Sync secrets via encore secret set. []
        •	Run encore run --watch --listen 0.0.0.0:4000. []
    •	Frontend dev process (Vite or other). []
    •	Connected dev mode via Tailscale (optional). []

Build & deploy
    •	stagecraft build:
        •	Backend Docker image via encore build docker. []
        •	Frontend image build (optional). []
        •	Push to registry. []
    •	stagecraft deploy:
        •	Per-host Compose generation based on roles. []
        •	Tailscale join/verification on hosts. []
        •	docker-rollout integration. []
        •	Simple release history tracking (version per env). []
    •	stagecraft rollback:
        •	Lookup previous version. []
        •	Re-deploy that version. []

Infra & CI
    •	stagecraft infra up / infra down using DO CLI. []
    •	stagecraft ci init to scaffold GitHub Actions workflow. []
    •	stagecraft ci run to trigger CI runs. []

Ops UX
    •	stagecraft status (per env/host/service). []
    •	stagecraft logs (per service/env). []
    •	stagecraft ssh (per host/role). []


## Contributing / development

Right now this is experimental and evolving quickly.

If you’re hacking on Stagecraft locally:
1.	Keep the spec document up to date: docs/stagecraft-spec.md￼.
2.	Keep the Implementation roadmap (this section) roughly in sync:
    •	Mark items [x] as they are built.
    •	Add new bullets as the design evolves.


- Split that section into `docs/implementation_status.md` and link it from README, or
- Add a simple convention in commit messages like `[#dev]` or `[#deploy]` to tag which checklist areas you’re working on.



