# SPDX-License-Identifier: AGPL-3.0-or-later
#
# Stagecraft - Stagecraft is a Go-based CLI that orchestrates local-first development and scalable single-host to multi-host deployments for multi-service applications powered by Docker Compose.
#
# Copyright (C) 2025  Bartek Kus
#
# This program is free software licensed under the terms of the GNU AGPL v3 or later.
#
# See https://www.gnu.org/licenses/ for license details.
#
name: CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install gofumpt
        run: go install mvdan.cc/gofumpt@latest

      - name: Verify formatting
        run: |
          gofumpt_out=$(gofumpt -l .)
          if [ -n "$gofumpt_out" ]; then
            echo "The following files are not gofumpt'ed:"
            echo "$gofumpt_out"
            exit 1
          fi

      # Run golangci-lint using .golangci.yml, modern defaults (no deprecated output format)
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6.2
          args: ./...
          install-mode: binary
          verify: true
          only-new-issues: false
          problem-matchers: false

  test:
    name: Tests and Coverage
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout Stagecraft
        uses: actions/checkout@v4
        with:
          path: stagecraft

      - name: Checkout Cortex
        uses: actions/checkout@v4
        with:
          repository: bartekus/cortex
          path: cortex

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build all packages
        working-directory: stagecraft
        run: go build ./...

      - name: Build stagecraft binary
        working-directory: stagecraft
        run: go build -o stagecraft ./cmd/stagecraft

      - name: Add stagecraft to PATH
        working-directory: stagecraft
        run: |
          echo "$(pwd)" >> $GITHUB_PATH

      - name: Run tests with coverage
        working-directory: stagecraft
        run: go test ./... -coverprofile=coverage.out -covermode=atomic

      - name: Build Cortex
        run: |
          cd cortex
          go build -o ../stagecraft/bin/cortex ./cmd/cortex

      - name: Enforce coverage threshold
        working-directory: stagecraft
        run: |
          # Install bc if not available (for floating point comparisons)
          sudo apt-get update && sudo apt-get install -y bc || true

          # Use Cortex for coverage check
          if [ -f "./bin/stagecraft" ]; then
             ./bin/cortex run test:coverage --fail-on-warning
          else
             ./scripts/run.sh test:coverage
          fi

      - name: Upload coverage to Codecov
        if: success() && github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: stagecraft/coverage.out
          fail_ci_if_error: false

  docs-and-spec:
    name: Docs and Spec Validation
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout Stagecraft
        uses: actions/checkout@v4
        with:
          path: stagecraft

      - name: Checkout Cortex
        uses: actions/checkout@v4
        with:
          repository: bartekus/cortex
          path: cortex

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build Cortex
        run: |
          cd cortex
          go build -o ../stagecraft/bin/cortex ./cmd/cortex

      - name: Run Checks
        working-directory: stagecraft
        env:
          CORTEX_HEADER_COMMENTS_PACKAGE: warn
        run: ./bin/cortex run docs:all

  commit-message:
    name: Commit Message Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # Check all commits in the PR
          if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            
            # Get list of commits
            COMMITS=$(git log --format="%H" $BASE_SHA..$HEAD_SHA)
            
            ERRORS=0
            for commit in $COMMITS; do
              COMMIT_MSG=$(git log --format="%B" -n 1 $commit)
              SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)
              
              # Check format
              if ! echo "$SUBJECT" | grep -qE '^(feat|fix|refactor|docs|test|ci|chore)\([A-Z][A-Z0-9_]+\): .+'; then
                echo "ERROR: Invalid commit message format in commit $commit"
                echo "  Subject: $SUBJECT"
                echo "  Expected: <type>(<FEATURE_ID>): <summary>"
                ERRORS=$((ERRORS + 1))
              fi
            done
            
            if [ $ERRORS -gt 0 ]; then
              echo "Found $ERRORS commit(s) with invalid message format"
              exit 1
            fi
            
            echo "âœ“ All commit messages are valid"
          else
            echo "Skipping commit message validation (not a PR)"
          fi

  license:
    name: License Headers
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Install addlicense
        run: go install github.com/google/addlicense@latest

      - name: Run license check
        run: addlicense -ignore 'internal/providers/backend/generic/test_script.sh' \
          -ignore '.bin/vendor/**' \
          -ignore '**/testdata/**' \
          -ignore '.idea/**' \
          -ignore '**/.stagecraft/**' \
          -check .
