# SPDX-License-Identifier: AGPL-3.0-or-later
#
# Stagecraft - Stagecraft is a Go-based CLI that orchestrates local-first development and scalable single-host to multi-host deployments for multi-service applications powered by Docker Compose.
#
# Copyright (C) 2025  Bartek Kus
#
# This program is free software licensed under the terms of the GNU AGPL v3 or later.
#
# See https://www.gnu.org/licenses/ for license details.
#
name: CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read

jobs:
  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Install gofumpt
        run: go install mvdan.cc/gofumpt@latest

      - name: Verify formatting
        run: |
          gofumpt_out=$(gofumpt -l .)
          if [ -n "$gofumpt_out" ]; then
            echo "The following files are not gofumpt'ed:"
            echo "$gofumpt_out"
            exit 1
          fi

      # Run golangci-lint using .golangci.yml, modern defaults (no deprecated output format)
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6.2
          args: ./...
          install-mode: binary
          verify: true
          only-new-issues: false
          problem-matchers: false

  test:
    name: Tests and Coverage
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build all packages
        run: go build ./...

      - name: Build stagecraft binary
        run: go build -o stagecraft ./cmd/stagecraft

      - name: Add stagecraft to PATH
        run: |
          echo "$(pwd)" >> $GITHUB_PATH

      - name: Run tests with coverage
        run: go test ./... -coverprofile=coverage.out -covermode=atomic

      - name: Enforce coverage threshold
        run: |
          # Install bc if not available (for floating point comparisons)
          sudo apt-get update && sudo apt-get install -y bc || true

          # Use the coverage check script
          if [ -x ./scripts/check-coverage.sh ]; then
            ./scripts/check-coverage.sh --fail-on-warning
          else
            echo "scripts/check-coverage.sh not found; skipping coverage threshold enforcement"
          fi

      - name: Upload coverage to Codecov
        if: success() && github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.out
          fail_ci_if_error: false

  docs-and-spec:
    name: Docs and Spec Validation
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: |
          python3 -m pip install --quiet --upgrade pip
          python3 -m pip install --quiet pyyaml

      - name: Validate spec/features.yaml
        run: |
          if [ -f spec/features.yaml ]; then
            python3 -c "import yaml; yaml.safe_load(open('spec/features.yaml'))" || {
              echo 'ERROR: spec/features.yaml is not valid YAML'
              exit 1
            }
            echo '✓ spec/features.yaml is valid YAML'
          else
            echo 'spec/features.yaml not found, skipping YAML validation'
          fi

      - name: Run spec validation script
        run: |
          if [ -f "scripts/validate-spec.sh" ]; then
            bash scripts/validate-spec.sh
          else
            echo "Spec validation script not found, skipping detailed checks"
            exit 1
          fi

      - name: Validate feature integrity
        run: |
          if [ -f "scripts/validate-feature-integrity.sh" ]; then
            bash scripts/validate-feature-integrity.sh
          else
            echo "Feature integrity validation script not found"
            exit 1
          fi

      - name: Check spec synchronization
        run: |
          if [ -f "scripts/spec-sync-check.sh" ]; then
            bash scripts/spec-sync-check.sh
          else
            echo "Spec sync check script not found"
            exit 1
          fi

      - name: Check header comments
        run: |
          if [ -f "scripts/check-header-comments.sh" ]; then
            bash scripts/check-header-comments.sh
          else
            echo "Header comment check script not found"
            exit 1
          fi

      - name: Check required tests
        run: |
          if [ -f "scripts/check-required-tests.sh" ]; then
            bash scripts/check-required-tests.sh
          else
            echo "Required tests check script not found"
            exit 1
          fi

  commit-message:
    name: Commit Message Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # Check all commits in the PR
          if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            
            # Get list of commits
            COMMITS=$(git log --format="%H" $BASE_SHA..$HEAD_SHA)
            
            ERRORS=0
            for commit in $COMMITS; do
              COMMIT_MSG=$(git log --format="%B" -n 1 $commit)
              SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)
              
              # Check format
              if ! echo "$SUBJECT" | grep -qE '^(feat|fix|refactor|docs|test|ci|chore)\([A-Z][A-Z0-9_]+\): .+'; then
                echo "ERROR: Invalid commit message format in commit $commit"
                echo "  Subject: $SUBJECT"
                echo "  Expected: <type>(<FEATURE_ID>): <summary>"
                ERRORS=$((ERRORS + 1))
              fi
            done
            
            if [ $ERRORS -gt 0 ]; then
              echo "Found $ERRORS commit(s) with invalid message format"
              exit 1
            fi
            
            echo "✓ All commit messages are valid"
          else
            echo "Skipping commit message validation (not a PR)"
          fi

  license:
    name: License Headers
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'

      - name: Install addlicense
        run: go install github.com/google/addlicense@latest

      - name: Run license check
        run: addlicense -ignore 'internal/providers/backend/generic/test_script.sh' \
          -ignore '.bin/vendor/**' \
          -ignore '**/testdata/**' \
          -ignore '.idea/**' \
          -ignore '**/.stagecraft/**' \
          -check .
