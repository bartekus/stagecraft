# DEV_TRAEFIK Feature Analysis Brief

This document captures the high level motivation, constraints, and success definition for DEV_TRAEFIK.

It is the starting point for the Implementation Outline and Spec.

This brief must be approved before outline work begins.

⸻

## 1. Problem Statement

CLI_DEV currently:

- Computes a deterministic dev topology.
- Generates dev files under `.stagecraft/dev` (Compose + Traefik).
- Provisions HTTPS certificates via DEV_MKCERT.
- Starts the dev stack via DEV_PROCESS_MGMT and Docker Compose.

However, the Traefik configuration generated by DEV_TRAEFIK does not yet wire the mkcert certificates into TLS configuration. Developers can generate certificates, but Traefik cannot use them for HTTPS termination. This means:

- `https://app.localdev.test` and `https://api.localdev.test` do not work even though certificates exist.
- The dev experience does not match production-style HTTPS routing.
- The value proposition of `stagecraft dev` as a complete, production-like dev environment is incomplete.

DEV_TRAEFIK TLS wiring fills this gap by consuming `CertConfig` from DEV_MKCERT and generating Traefik static and dynamic configuration that references the certificate files for HTTPS termination.

⸻

## 2. Motivation

### Developer Experience

- **HTTPS routing works**: Developers should be able to hit `https://app.localdev.test` and `https://api.localdev.test` and get valid TLS connections using the mkcert-generated certificates.

- **Production parity**: Dev environments should use HTTPS and host-based routing identical to production patterns.

- **Complete integration**: The full stack from `stagecraft dev` should work end-to-end: certificates → Traefik config → routing → services.

### Operational Reliability

- **Deterministic TLS config**: Traefik TLS configuration should reference deterministic certificate paths from DEV_MKCERT (`dev-local.pem`, `dev-local-key.pem`).

- **Clear error behavior**: When HTTPS is enabled but certificates are missing or invalid, DEV_TRAEFIK should fail with clear, actionable errors.

- **Idempotent generation**: Running `stagecraft dev` multiple times must produce identical Traefik configs for the same inputs.

### CI and Automation

- **HTTPS toggle**: DEV_TRAEFIK must respect `--no-https` and generate HTTP-only configs when HTTPS is disabled.

- **Deterministic output**: Traefik configs must be deterministic so they can be version controlled and reviewed.

⸻

## 3. Users and User Stories

### Developers

- As a developer, I want `stagecraft dev` to generate Traefik configs that enable HTTPS on `https://app.localdev.test` and `https://api.localdev.test` using mkcert certificates.

- As a developer, I want `stagecraft dev --no-https` to generate HTTP-only Traefik configs when I do not need HTTPS.

- As a developer, I want Traefik configs to be deterministic so I can review them in `.stagecraft/dev/traefik/` and understand routing.

### Platform Engineers

- As a platform engineer, I want Traefik TLS configuration to reference the exact certificate paths from DEV_MKCERT (`dev-local.pem`, `dev-local-key.pem`).

- As a platform engineer, I want errors about missing certificates or invalid TLS config to be clear and actionable.

- As a platform engineer, I want Traefik config generation to be deterministic and testable with golden files.

### CLI_DEV (consumer)

- As CLI_DEV, I want to pass `CertConfig` from DEV_MKCERT to DEV_TRAEFIK and get back Traefik configs with TLS wired correctly.

- As CLI_DEV, I want DEV_TRAEFIK to fail clearly when HTTPS is enabled but `CertConfig.Enabled` is false.

⸻

## 4. Success Criteria (v1)

1. When HTTPS is enabled (`CertConfig.Enabled = true`), DEV_TRAEFIK:

   - Generates Traefik static config with HTTPS entrypoint (`:443`).

   - Generates Traefik dynamic config with routers that reference TLS certificates.

   - Uses `CertConfig.CertFile` and `CertConfig.KeyFile` paths in TLS configuration.

   - Generates routers for frontend and backend domains (provided by CLI_DEV via `ComputeDomains()`) with TLS enabled. Default domains are `app.localdev.test` and `api.localdev.test`, but may be overridden via `dev.domains.*` in config.

2. When HTTPS is disabled (`CertConfig.Enabled = false`):

   - DEV_TRAEFIK generates HTTP-only routers (no TLS config).

   - No certificate paths are referenced in the generated configs.

3. DEV_TRAEFIK is deterministic:

   - Same inputs produce identical YAML output.

   - Router and service ordering is lexicographic.

   - Certificate paths are stable and documented.

4. Error handling:

   - If `CertConfig.Enabled = false` but HTTPS is expected, DEV_TRAEFIK returns a clear error.

   - If certificate paths are invalid or missing, errors are surfaced clearly.

5. Integration:

   - DEV_TRAEFIK consumes `mkcert.CertConfig` as input.

   - Generated configs are written to `.stagecraft/dev/traefik/` for consumption by Traefik container.

   - Configs can be used directly by Traefik via file provider or command-line flags.

⸻

## 5. Risks and Constraints

### Determinism Constraints

- Traefik config YAML must be deterministic: same inputs produce identical output.

- Certificate paths must match exactly what DEV_MKCERT produces (`dev-local.pem`, `dev-local-key.pem`).

- Router and service ordering must be lexicographic for stable output.

### External Dependencies

- DEV_TRAEFIK depends on DEV_MKCERT for certificate paths.

- DEV_TRAEFIK does not validate certificate files exist; that is Traefik's responsibility at runtime.

- DEV_TRAEFIK does not start or manage Traefik processes; that is DEV_PROCESS_MGMT's responsibility.

### Implementation Constraints

- v1 scope is limited to:

  - Single certificate pair covering all dev domains (from DEV_MKCERT v1).

  - Dev domains provided by CLI_DEV via `ComputeDomains()` (defaults: `app.localdev.test`, `api.localdev.test`, configurable via `dev.domains.*`).

  - Traefik v2.x configuration format.

- DEV_TRAEFIK must not:

  - Modify certificate files.

  - Start Traefik processes.

  - Validate certificate validity (Traefik does this).

⸻

## 6. Alternatives Considered

### Alternative 1 - Do not wire TLS in v1

Rejected because it leaves the HTTPS dev experience incomplete. Certificates are generated but unused, reducing the value of DEV_MKCERT.

### Alternative 2 - Use Traefik's file provider with separate cert files per domain

Rejected for v1 because DEV_MKCERT v1 generates a single certificate pair covering all domains. This can be revisited in future if per-domain certificates are needed.

### Alternative 3 - Use Traefik's Docker provider labels instead of file-based config

Rejected for v1 because file-based config is simpler, more deterministic, and easier to review. Docker labels can be added in future iterations.

⸻

## 7. Dependencies

Required upstream work:

- DEV_MKCERT:

  - Implementation complete.

  - Provides `CertConfig` with `CertFile`, `KeyFile`, `Domains`, and `Enabled`.

- CLI_DEV:

  - Dev topology and domain computation.

  - Integration point for calling DEV_TRAEFIK with `CertConfig`.

DEV_TRAEFIK must avoid:

- Direct certificate generation (DEV_MKCERT's responsibility).

- Traefik process management (DEV_PROCESS_MGMT's responsibility).

- Docker Compose file generation (DEV_COMPOSE_INFRA's responsibility).

It only generates Traefik configuration files that reference certificates and routes.

⸻

## 8. Approval

- Author: [To be filled]

- Reviewer: [To be filled]

- Date: [To be filled]

Once approved, the DEV_TRAEFIK Implementation Outline may begin.

